<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Lightstribe WS2811/WS2812: ws2811lichterkette.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="hochschullogo.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lightstribe WS2811/WS2812
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('ws2811lichterkette_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">ws2811lichterkette.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>main file for interfacing WS2811/WS2812 LEDs  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="globals_8h_source.html">globals.h</a>&quot;</code><br />
<code>#include &lt;avr/io.h&gt;</code><br />
<code>#include &lt;util/delay.h&gt;</code><br />
<code>#include &lt;avr/interrupt.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &quot;<a class="el" href="_lightstribe_8h_source.html">Lightstribe.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="_led_effects_8h_source.html">LedEffects.h</a>&quot;</code><br />
</div>
<p><a href="ws2811lichterkette_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a77366c1bd428629dc898e188bfd182a3"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a77366c1bd428629dc898e188bfd182a3"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>EXTERN</b></td></tr>
<tr class="separator:a77366c1bd428629dc898e188bfd182a3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a62634036639f88eece6fbf226b45f84b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a62634036639f88eece6fbf226b45f84b"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#a62634036639f88eece6fbf226b45f84b">BAUD</a>&#160;&#160;&#160;38400</td></tr>
<tr class="memdesc:a62634036639f88eece6fbf226b45f84b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Baudrate definition, choose 76800 or 38400, faster value prefered, the maximum speed of ESP8266 software-UART is 38400. <br /></td></tr>
<tr class="separator:a62634036639f88eece6fbf226b45f84b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a711e9130c825a7269c8c87dbb57a85e0"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a711e9130c825a7269c8c87dbb57a85e0"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#a711e9130c825a7269c8c87dbb57a85e0">MYUBRR</a>&#160;&#160;&#160;<a class="el" href="globals_8h.html#a43bafb28b29491ec7f871319b5a3b2f8">F_CPU</a>/16/<a class="el" href="ws2811lichterkette_8c.html#a62634036639f88eece6fbf226b45f84b">BAUD</a> -1</td></tr>
<tr class="memdesc:a711e9130c825a7269c8c87dbb57a85e0"><td class="mdescLeft">&#160;</td><td class="mdescRight">calculate baudrate register value <br /></td></tr>
<tr class="separator:a711e9130c825a7269c8c87dbb57a85e0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0efa6385d653e699e90640b35a0c2b54"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a0efa6385d653e699e90640b35a0c2b54"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>BAUD_REAL</b>&#160;&#160;&#160;(<a class="el" href="globals_8h.html#a43bafb28b29491ec7f871319b5a3b2f8">F_CPU</a>/(16*(<a class="el" href="ws2811lichterkette_8c.html#a711e9130c825a7269c8c87dbb57a85e0">MYUBRR</a>+1)))		/*real baudrate in this configuration*/</td></tr>
<tr class="separator:a0efa6385d653e699e90640b35a0c2b54"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac46ef58ff714ed839a5a324c358f2c8f"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ac46ef58ff714ed839a5a324c358f2c8f"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>BAUD_ERROR</b>&#160;&#160;&#160;((BAUD_REAL*1000)/<a class="el" href="ws2811lichterkette_8c.html#a62634036639f88eece6fbf226b45f84b">BAUD</a>)		/*calculate baudrate error*/</td></tr>
<tr class="separator:ac46ef58ff714ed839a5a324c358f2c8f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8aac8c5098aaf915463fb31715efa09f"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8aac8c5098aaf915463fb31715efa09f"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#a8aac8c5098aaf915463fb31715efa09f">PREAMBLE</a>&#160;&#160;&#160;254</td></tr>
<tr class="memdesc:a8aac8c5098aaf915463fb31715efa09f"><td class="mdescLeft">&#160;</td><td class="mdescRight">definition of the preamble is 254, no other data field must contain this value <br /></td></tr>
<tr class="separator:a8aac8c5098aaf915463fb31715efa09f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aec9ae4a8d59e838ac8ed93ad0de8e827"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aec9ae4a8d59e838ac8ed93ad0de8e827"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#aec9ae4a8d59e838ac8ed93ad0de8e827">LENINDEX</a>&#160;&#160;&#160;1</td></tr>
<tr class="memdesc:aec9ae4a8d59e838ac8ed93ad0de8e827"><td class="mdescLeft">&#160;</td><td class="mdescRight">definition of the second field; contains the total packet length (including the preamble) <br /></td></tr>
<tr class="separator:aec9ae4a8d59e838ac8ed93ad0de8e827"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8d4e4cf47dd6136ace963623e1a8e27c"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8d4e4cf47dd6136ace963623e1a8e27c"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#a8d4e4cf47dd6136ace963623e1a8e27c">EFFECTINDEX</a>&#160;&#160;&#160;2</td></tr>
<tr class="memdesc:a8d4e4cf47dd6136ace963623e1a8e27c"><td class="mdescLeft">&#160;</td><td class="mdescRight">definition of 1 Byte effect at third position, the MSBit is used to choose WS2811/WS2812 (color profile RGB or GRB) <br /></td></tr>
<tr class="separator:a8d4e4cf47dd6136ace963623e1a8e27c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9ff437877d0878dd16eacf103a1e1c40"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a9ff437877d0878dd16eacf103a1e1c40"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#a9ff437877d0878dd16eacf103a1e1c40">DELAYINDEX</a>&#160;&#160;&#160;3</td></tr>
<tr class="memdesc:a9ff437877d0878dd16eacf103a1e1c40"><td class="mdescLeft">&#160;</td><td class="mdescRight">definition of the delay field, contains the delay duplicator <br /></td></tr>
<tr class="separator:a9ff437877d0878dd16eacf103a1e1c40"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afbc75dc20761a05dda7cbb70b9b322dd"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="afbc75dc20761a05dda7cbb70b9b322dd"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#afbc75dc20761a05dda7cbb70b9b322dd">NUMOFLEDINDEX</a>&#160;&#160;&#160;4</td></tr>
<tr class="memdesc:afbc75dc20761a05dda7cbb70b9b322dd"><td class="mdescLeft">&#160;</td><td class="mdescRight">field position for the number of LEDs to control, should be max. 200 (dynamic memory allocation for the lightdata array) <br /></td></tr>
<tr class="separator:afbc75dc20761a05dda7cbb70b9b322dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ac7b3df0fa68526d64c732d5f916e34b1"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#ac7b3df0fa68526d64c732d5f916e34b1">init_uart</a> (void)</td></tr>
<tr class="memdesc:ac7b3df0fa68526d64c732d5f916e34b1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Init the hardware UART with Baud = 76800/38400, depending on <a class="el" href="ws2811lichterkette_8c.html#a62634036639f88eece6fbf226b45f84b">BAUD</a> definition, 8 Databits, 1 Stopbit, no Parity.  <a href="#ac7b3df0fa68526d64c732d5f916e34b1">More...</a><br /></td></tr>
<tr class="separator:ac7b3df0fa68526d64c732d5f916e34b1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a840291bc02cba5474a4cb46a9b9566fe"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a840291bc02cba5474a4cb46a9b9566fe"></a>
int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a> (void)</td></tr>
<tr class="memdesc:a840291bc02cba5474a4cb46a9b9566fe"><td class="mdescLeft">&#160;</td><td class="mdescRight">main function, should never end, effects are handled in main while <br /></td></tr>
<tr class="separator:a840291bc02cba5474a4cb46a9b9566fe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a09ce999e15ad60b8a3f07d08af1946f9"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a09ce999e15ad60b8a3f07d08af1946f9"></a>
&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ws2811lichterkette_8c.html#a09ce999e15ad60b8a3f07d08af1946f9">ISR</a> (USART_RX_vect)</td></tr>
<tr class="memdesc:a09ce999e15ad60b8a3f07d08af1946f9"><td class="mdescLeft">&#160;</td><td class="mdescRight">UART Interrupt handler, interrupts when new data is available in the RX buffer. <br /></td></tr>
<tr class="separator:a09ce999e15ad60b8a3f07d08af1946f9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>main file for interfacing WS2811/WS2812 LEDs </p>
<p>This file contains the main environment for interfacing WS2811/WS2812 LEDs with an AVR. The implementation has been done for an atmega328p. You may use another controller but be aware of the memory you need for the color array (dynamically allocated). The AVR interfaces the one wire of the LEDs. All operations (effects, colorchange etc.) are done on an lightdata array, that needs to be transmitted to the LEDs after your operations. The reason for this is the critical timing for interfacing the LEDs. So also be aware if you change the clock speed. If you do so you have to change the number of NOPs in the macros of <a class="el" href="_lightstribe_8h.html" title="basic functions for controlling WS2811/WS2812 LEDs ">Lightstribe.h</a>. Because of the critical timing compile all files at optimization O1! Furthermore be aware of the <a class="el" href="ws2811lichterkette_8c.html#a62634036639f88eece6fbf226b45f84b">BAUDRATE </a> changes, the BAUD error may be to worse if you change the CPU frequency. <br />
 The one wire output is on the PIN B0! You can change in the main and <a class="el" href="_lightstribe_8h.html">Lightstribe.h</a>. <br />
 By default this file just initializes the AVR system, no updates to the LEDs are done by default. To change the LED configuration you need to access the AVR UART Interface with another controller (FTDI is also possible). Over the UART you send a message containing all relevant information for the system. Therefore a simple protocol is used: 1 Byte preamble (254) 1 Byte total packet length (including the preamble) 1 Byte effect 1 Byte effect delay (effect speed) 1 Byte number of LEDs to control n Bytes containing 8-Bit color values (RGB 3-3-2), depended on the effect, max. 50 values The preamble 254 must never be used at another position!!!<br />
 Protocol examples:<br />
 <a class="el" href="_led_effects_8h.html#a996334f1d53296a931624800377d5b01">SETFULLCOLOR</a>: 254 6 0 1 20 22 <br />
 <a class="el" href="_led_effects_8h.html#a2f349ea8f5412514d90f138ede08da62">FILLUP</a>: 254 7 1 22 20 22 201 <br />
 <a class="el" href="_led_effects_8h.html#a38eec52a7dccb94ff563e30eda32c891">BLINK</a>: 254 6 2 55 20 56 <br />
 <a class="el" href="_led_effects_8h.html#ab6e06c8b4c17edc65d75be641a0fc39b">RUNLED</a>: 254 7 3 55 20 56 151 <br />
 <a class="el" href="_led_effects_8h.html#a2805176df86592658ae06a508a558720">INITRAINBOW</a>: 254 5 9 0 20 <br />
 <a class="el" href="_led_effects_8h.html#a85bd242525add173bd67847b7acac00b">ROTATE_R</a>: 254 5 11 23 20 <br />
 <a class="el" href="_led_effects_8h.html#a686dea444026cbf1236c24e7edb3a96d">CUSTOM</a>: 254 8 12 1 20 22 201 60 <br />
 <a class="el" href="_led_effects_8h.html#a5645ec20d3cd39bfc1c9ad5ec99db2f2">EASTEREGG</a>: 254 5 13 2 20 <br />
</p>
<p>The UART communication is done by using an RX interrupt an storing the data into a temp array. In the main loop a flag shows if a data packet is complete. So you will get no update on the LEDs if the UART package was wrong (too short). In the project this programm has been written the UART was controlled by an ESP8266 or BLE113. Have Fun! </p><dl class="section version"><dt>Version</dt><dd>V1.00 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>05.01.2016 </dd></dl>
<dl class="section author"><dt>Authors</dt><dd>Wank Florian </dd></dl>

<p>Definition in file <a class="el" href="ws2811lichterkette_8c_source.html">ws2811lichterkette.c</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ac7b3df0fa68526d64c732d5f916e34b1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void init_uart </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Init the hardware UART with Baud = 76800/38400, depending on <a class="el" href="ws2811lichterkette_8c.html#a62634036639f88eece6fbf226b45f84b">BAUD</a> definition, 8 Databits, 1 Stopbit, no Parity. </p>
<dl class="section return"><dt>Returns</dt><dd>void </dd></dl>
<dl class="section note"><dt>Note</dt><dd>This function depends on the oscillator clock frequency and the <a class="el" href="ws2811lichterkette_8c.html#a62634036639f88eece6fbf226b45f84b">BAUD</a> defintion. If your UART is not working first check all frequency issues (Fuse settings, clock speed, clock divider, Baudrate) </dd></dl>

<p>Definition at line <a class="el" href="ws2811lichterkette_8c_source.html#l00174">174</a> of file <a class="el" href="ws2811lichterkette_8c_source.html">ws2811lichterkette.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="ws2811lichterkette_8c.html">ws2811lichterkette.c</a></li>
    <li class="footer">Generated on Thu May 5 2016 13:11:01 for Lightstribe WS2811/WS2812 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
